{% extends "base/main.html" %}

{% block page-content %}
  <p class="ajax"></p>

  <div class="col-sm-12">
    <h2>Existing hosts</h2>

    <p>This table contains the hosts currently configured in the system.</p>

    <div class="btn-group btn-group-justified">
      <div class="btn-group">
        <button type="button"
            class="btn btn-success disabled dropdown-toggle updateEnv" 
            data-toggle="dropdown">
          Update Environment <span class="caret"></span>
        </button>
        <ul class="dropdown-menu" role="menu">
          {% for e in environments %}
            <li><a class="updateEvironment" id="{{e.id}}">{{e.name}}</a></li>
          {% endfor %}
        </ul>
      </div>
      <a href="#" class="btn btn-warning changeButton disabled rebuild">Rebuild host</a>
      <a href="#" class="btn btn-danger changeButton disabled deleteHost">Delete Host</a>
    </div>
    <p class="tablemessage"></p>
    <div class="hosttable"></div>
  </div>
  <div class="col-sm-12">
    <h2>Add new host</h2>
    <p>Use the following form to create a new host:</p>
    <p class="formMessage"></p>
    <div class="addHostForm"></div>
  </div>

  <script>
    function reloadTable() {
      $( ".hosttable" ).load( "{% url 'hostAjaxTable' %}", function() {
        // Select all hosts if the "selectAllHosts" checkbox is clicked on
        $(".selectAllHosts").change(function() {
          $(".selectHost").attr('checked', this.checked);
        });
        
        // Enable/disable buttons based on how many hosts are selected
        $(".selectHost").change(function() {
          var antall = $('.selectHost:checked').length;
          if(antall == 0) {
            $(".addInterface").toggleClass('disabled', true);
            $(".updateEnv").toggleClass('disabled', true);
            $(".rebuild").toggleClass('disabled', true);
            $(".deleteHost").toggleClass('disabled', true);
          } else if (antall == 1) {
            $(".addInterface").toggleClass('disabled', false);
            $(".updateEnv").toggleClass('disabled', false);
            $(".rebuild").toggleClass('disabled', false);
            $(".deleteHost").toggleClass('disabled', false);
          } else {
            $(".addInterface").toggleClass('disabled', true);
            $(".updateEnv").toggleClass('disabled', false);
            $(".rebuild").toggleClass('disabled', false);
            $(".deleteHost").toggleClass('disabled', false);
          }
        });
        
        $(".updateEvironment").click(function() {
          var data = {'environment': this.id};
          data['selected'] = $('input[name="selectHost"]:checked').serialize();

          if (confirm('Are you sure you want to update these hosts?')) {
            $(".tablemessage").html("<div class='alert alert-info'>" +
                "Request sent to the server</div>");
            $.ajax({
              type        : 'POST',
              url         : '{% url 'hostEnvironment' %}',
              data        : data,
              dataType    : 'json',
            }).done(function(response) {
              $(".tablemessage").html("<div class='alert alert-" +
                  response['status'] + "'>" +
                  response['message'] + "</div>");

              if(response['status'] == 'success') {
                reloadTable();
              }
            });
          }
        });
        $(".deleteHost").click(function() {
          var selected = $('input[name="selectHost"]:checked').serialize()
          if (confirm('Are you sure you want to delete these hosts?')) {
            $(".tablemessage").html("<div class='alert alert-info'>" +
                "Request sent to the server</div>");
            $.ajax({
              type        : 'POST',
              url         : '{% url 'hostDelete' %}',
              data        : {'selected':selected},
              dataType    : 'json',
            }).done(function(response) {
              $(".tablemessage").html("<div class='alert alert-" +
                  response['status'] + "'>" +
                  response['message'] + "</div>");

              if(response['status'] == 'success') {
                reloadTable();
              }
            });
          }
        });
        $(".rebuild").click(function() {
          var selected = $('input[name="selectHost"]:checked').serialize()

          if (confirm('Are you sure you want to reinstall these hosts?')) {
            $(".tablemessage").html("<div class='alert alert-info'>" +
                "Request sent to the server</div>");
            $.ajax({
              type        : 'POST',
              url         : '{% url 'hostProvision' %}',
              data        : {'selected':selected},
              dataType    : 'json',
            }).done(function(response) {
              $(".tablemessage").html("<div class='alert alert-" +
                  response['status'] + "'>" +
                  response['message'] + "</div>");

              if(response['status'] == 'success') {
                reloadTable();
              }
            });
          }
        });
      });
    }

    function reloadForm() {
      $( ".addHostForm" ).load( "{% url 'hostAjaxForm' %}", function() {
        $(".newHost").click(function() {
          var formData = { 
            'csrfmiddlewaretoken' : $('input[name=csrfmiddlewaretoken]').val(),
            'hostname'            : $('input[id=hostname]').val(),
            'domain'              : $('#domain option:selected').text(),
            'environment'         : $('#environment option:selected').text(), 
            'ifname'              : $('input[id=ifname]').val(),
            'ifdesc'              : $('input[id=ifdesc]').val(),
            'mac'                 : $('input[id=mac]').val(),
            'subnet'              : $('#subnet option:selected').text(),
            'ipv4'                : $('input[id=ipv4]').val(),
          };

          var fields = ["hostname", "domain", "environment", "ifname", 
              "ifdesc", "mac", "subnet"];
          var descriptions = ["Hostname", "Domain", "Evironment", 
              "Interface description", "Interface name", "MAC Address",
              "Subnet"]
          var missing = ""

          for(f in fields) {
            if(! formData[fields[f]]) {
              missing += "'" + descriptions[f] + "' ";
            }
          }
          if(missing) {
            $(".formMessage").html("<div class='alert alert-warning'>" +
                "Missing the fields " + missing + "</div>");
          } else {
            $(".formMessage").html("<div class='alert alert-info'>" +
                "Request sent to the server</div>");
            $.ajax({
              type        : 'POST',
              url         : '{% url 'hostNew' %}',
              data        : formData,
              dataType    : 'json',
              encode      : true
            }).done(function(response) {
              $(".formMessage").html("<div class='alert alert-" +
                  response['status'] + "'>" +
                  response['message'] + "</div>");

              if(response['status'] == 'success') {
                reloadTable();
                reloadForm();
              }
            });
          }
        });
      });
    }

    $(document).ready(function(){
      reloadTable();
      reloadForm();
    });
  </script>
{% endblock page-content %}
